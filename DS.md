# 開発状況

## 実装状況
- [x] WebSocketベースのCodex CLI実行（基本機能）
- [x] JWT認証によるアクセス制御
- [x] BullMQによる非同期ジョブ管理
- [x] Redis接続設定の標準化
- [x] MCP TypeScript SDKに準拠したSSE実装
- [x] エラーハンドリングの強化
- [x] ストレージバックエンドの抽象化（Redis/SQLite対応）
- [x] ドキュメント更新（MCP/SSE使用方法）
- [x] 包括的なテストケース作成
- [x] パフォーマンス最適化
- [x] 監視ダッシュボード実装

## アーキテクチャ概要
Codex MCPラッパーは、Codex CLIを効率的に利用するためのNestJSベースのサーバーアプリケーションです。WebSocketとSSE（Server-Sent Events）の両方をサポートし、MCP（Model Context Protocol）TypeScript SDKの仕様に準拠しています。バックエンドストレージとしてRedisまたはSQLiteを選択可能です。

アプリケーションは以下のコンポーネントで構成されています：
1. APIレイヤー: HTTP/WebSocketエンドポイントを提供
2. 認証レイヤー: JWT認証によるアクセス制御
3. キュー管理: BullMQ/SQLiteによる非同期ジョブ処理
4. 実行エンジン: Codex CLI実行とストリーミング
5. MCP対応レイヤー: SSEベースのMCPプロトコル実装
6. ストレージ抽象化レイヤー: Redis/SQLiteを選択可能に

## 開発進捗
- [x] プロジェクト初期化
- [x] WebSocket機能実装
- [x] BullMQジョブキュー統合
- [x] JWT認証実装
- [x] Docker環境構築
- [x] MCP/SSEプロトコル実装
- [x] Redis設定の最適化
- [x] ADR（アーキテクチャ決定記録）の作成
- [x] ストレージ抽象化の実装
- [x] 包括的テストスイート
- [x] CI/CDパイプライン構築

## 技術的な決定事項
- WebSocketとSSE両方のプロトコルをサポートし、後方互換性を維持
- NestJSフレームワークによるモジュラーな設計
- Docker+Redis構成によるコンテナ化とスケーラビリティ確保
- BullMQ/SQLiteによる非同期ジョブ処理と再試行戦略
- JWT認証によるシンプルかつ拡張可能な認証システム
- 指数バックオフによるRedis接続再試行戦略の実装
- エンドポイント分離によるプロトコル独立性の確保
- ストレージバックエンド抽象化による開発/デプロイの柔軟性向上

## 今後の開発計画
### フェーズ1: 安定化（完了）
- コアWebSocket機能実装
- 基本的な認証と実行機能
- Docker環境設定

### フェーズ2: MCP対応（完了）
- SSEベースのMCP実装
- エラーハンドリング改善
- Redis設定最適化
- ドキュメント更新

### フェーズ3: 拡張性向上（完了）
- ストレージバックエンド抽象化
- SQLite対応追加
- 設定オプションの拡充
- コードリファクタリング

### フェーズ4: 品質向上（進行中）
- テストカバレッジ拡大
- パフォーマンス最適化
- セキュリティ強化
- ロギング&モニタリング改善

### フェーズ5: 拡張（予定）
- 追加モデルサポート
- アドミン管理画面
- メトリクス収集
- 高度なスケーリング機能

## アーキテクチャ図
```
┌─────────────────────────────────────────┐
│            Codex MCP Wrapper            │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  │
│  │   RPC   │  │WebSocket│  │  MCP/   │  │
│  │  API    │  │ Gateway │  │  SSE    │  │
│  └────┬────┘  └────┬────┘  └────┬────┘  │
│       │            │            │       │
│  ┌────▼────────────▼────────────▼────┐  │
│  │          認証ミドルウェア           │  │
│  └────────────────┬─────────────────┘  │
│                   │                    │
│  ┌────────────────▼─────────────────┐  │
│  │           Codex Service          │  │
│  └────────────────┬─────────────────┘  │
│                   │                    │
│  ┌────────────────▼─────────────────┐  │
│  │        抽象ストレージレイヤー        │  │
│  └────────┬─────────────────┬───────┘  │
│           │                 │          │
│  ┌────────▼────┐    ┌───────▼────────┐ │
│  │   Redis     │    │    SQLite      │ │
│  │  (BullMQ)   │    │(ファイルベース)  │ │
│  └────────┬────┘    └───────┬────────┘ │
│           │                 │          │
│  ┌────────▼─────────────────▼────────┐ │
│  │          Codex Worker           │ │
│  └────────────────┬─────────────────┘ │
│                   │                   │
│  ┌────────────────▼─────────────────┐ │
│  │           Codex CLI              │ │
│  └─────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

最終更新: 2025/05/22 20:46
